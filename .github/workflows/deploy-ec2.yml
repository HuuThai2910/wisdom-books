name: Deploy to EC2

on:
    push:
        branches:
            - main
            - develop
    workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ” Checkout code
              uses: actions/checkout@v4

            - name: â˜• Setup Java 21
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "21"
                  cache: "maven"

            - name: ðŸ”¨ Build with Maven
              run: |
                  cd backend
                  chmod +x mvnw
                  ./mvnw clean package -DskipTests

            - name: ðŸ“¦ Verify JAR
              run: |
                  ls -lh backend/target/*.jar
                  echo "JAR_NAME=$(ls backend/target/*.jar | xargs -n 1 basename)" >> $GITHUB_ENV

            - name: ðŸ“¤ Copy JAR to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "backend/target/*.jar"
                  target: "/tmp/"
                  strip_components: 2

            - name: ðŸš€ Deploy and Restart Service
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # Backup JAR cÅ©
                      if [ -f /opt/wisdom-books/backend/wisdom-books-0.0.1-SNAPSHOT.jar ]; then
                        BACKUP_NAME="wisdom-books-0.0.1-SNAPSHOT.jar.backup.$(date +%Y%m%d_%H%M%S)"
                        sudo cp /opt/wisdom-books/backend/wisdom-books-0.0.1-SNAPSHOT.jar /opt/wisdom-books/backend/$BACKUP_NAME
                        echo "ðŸ“¦ Backup: $BACKUP_NAME"
                      fi

                      # Di chuyá»ƒn JAR má»›i
                      sudo mv /tmp/wisdom-books-0.0.1-SNAPSHOT.jar /opt/wisdom-books/backend/
                      sudo chown wisdom:wisdom /opt/wisdom-books/backend/wisdom-books-0.0.1-SNAPSHOT.jar

                      # Restart service
                      echo "ðŸ”„ Restarting service..."
                      sudo systemctl restart wisdom-books

                      # Äá»£i service khá»Ÿi Ä‘á»™ng
                      sleep 5

                      # Kiá»ƒm tra status
                      sudo systemctl status wisdom-books --no-pager || true

                      # XÃ³a backup cÅ© hÆ¡n 7 ngÃ y
                      find /opt/wisdom-books/backend/ -name "*.backup.*" -mtime +7 -delete 2>/dev/null || true

                      echo "âœ… Deploy completed!"

            - name: ðŸ¥ Health Check
              run: |
                  echo "Waiting for application to start..."
                  sleep 10

                  # Kiá»ƒm tra health endpoint (náº¿u cÃ³)
                  curl -f http://${{ secrets.EC2_HOST }}:8080/actuator/health || true

                  echo "âœ… Deployment successful!"

            - name: ðŸ“ Deployment Summary
              if: always()
              run: |
                  echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **EC2 Host:** ${{ secrets.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **API URL:** http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
                  echo "- **Swagger:** http://${{ secrets.EC2_HOST }}:8080/swagger-ui.html" >> $GITHUB_STEP_SUMMARY
