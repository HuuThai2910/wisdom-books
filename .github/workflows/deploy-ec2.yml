name: Deploy to EC2

on:
    push:
        branches:
            - main
            - develop
    workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            - name: ðŸ” Checkout code
              uses: actions/checkout@v4

            - name: â˜• Setup Java 21
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "21"
                  cache: "maven"

            - name: ðŸ”¨ Build with Maven
              run: |
                  cd backend
                  chmod +x mvnw
                  ./mvnw clean package -DskipTests -T 2C --batch-mode

            - name: ðŸ“¦ Verify JAR
              run: |
                  ls -lh backend/target/*.jar
                  echo "JAR_NAME=$(ls backend/target/*.jar | xargs -n 1 basename)" >> $GITHUB_ENV

            - name: ðŸ“¤ Copy JAR to EC2
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  source: "backend/target/*.jar"
                  target: "/tmp/"
                  strip_components: 2

            - name: ðŸš€ Deploy and Restart Service
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ${{ secrets.EC2_USER }}
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # Di chuyá»ƒn JAR má»›i (khÃ´ng backup Ä‘á»ƒ nhanh hÆ¡n)
                      sudo mv /tmp/wisdom-books-0.0.1-SNAPSHOT.jar /opt/wisdom-books/backend/
                      sudo chown wisdom:wisdom /opt/wisdom-books/backend/wisdom-books-0.0.1-SNAPSHOT.jar

                      # Restart service nhanh
                      sudo systemctl restart wisdom-books

                      echo "âœ… Deploy completed!"

            - name: ðŸ“ Deployment Summary
              if: always()
              run: |
                  echo "## âœ… Deployment Completed" >> $GITHUB_STEP_SUMMARY
                  echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- API: http://${{ secrets.EC2_HOST }}:8080" >> $GITHUB_STEP_SUMMARY
